USE DBSALESPP
GO


if exists (select * from dbo.sysobjects where id = object_id(N'[spp].[V_OLAP_DELIVER]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [spp].[V_OLAP_DELIVER]
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[spp].[V_OLAP_DELIVER_POS]') and OBJECTPROPERTY(id, N'IsView') = 1)
drop view [spp].[V_OLAP_DELIVER_POS]
GO








CREATE VIEW spp.V_OLAP_DELIVER
AS
SELECT  
spp.OLAP_STORE.COMSERNO, 
spp.OLAP_STORE.NR, 
ISNULL(spp.TDELIVER.COMSERNCCH , '') AS COMSERNCCH, 
ISNULL(spp.TDELIVER.COMSERNCHN , '') AS COMSERNCHN, 
ISNULL(spp.TDELIVER.COMSERNWHS , '') AS COMSERNWHS, 
OLAP_LPROPROD.PRODSERN, 
OLAP_LPROPROD.PRODEXPAND ,
ISNULL(spp.TDELENTR.SALMSERN,'') AS SALMSERN ,

ISNULL((SELECT 
CASE
	WHEN COUNT(*)>1 THEN '-1'
	ELSE MAX(SALMSERN)
END AS SALMSERN 
FROM spp.OLAP_LCOMPGR OLAP_LCOMPGR  LEFT OUTER JOIN spp.OLAP_LPROPGR OLAP_LPROPGR ON OLAP_LCOMPGR.PGRSERN=OLAP_LPROPGR.PGRSERN 
WHERE OLAP_LCOMPGR.COMSERNO=spp.OLAP_STORE.COMSERNO AND OLAP_LPROPGR.PRODSERN=OLAP_LPROPROD.PRODSERN
),'0')
 AS STORE_SALMSERN ,


spp.TDELIVER.DELDATE,

	CASE DELEVOLFLG
		WHEN '1' THEN (CASE DELEPRFLAG
					WHEN '1'   THEN  1 								-- VOL IN CASES, PRICE IN CASES
					WHEN '2'   THEN (1/OLAP_LPROPROD.PRODPALLET)			-- VOL IN CASES , PRICE IN PALLETS
					ELSE 	(OLAP_LPROPROD.PRODSIZE) 					-- VOL IN CASES, PRICE IN CONS PKGS
					END)*spp.TDELENTR.DELEPRICE*OLAP_LPROPROD.PRODMONEY_MULT* spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT
		ELSE (CASE DELEPRFLAG
				WHEN '1'   THEN (1/OLAP_LPROPROD.PRODSIZE) 							-- VOL IN CONS PKG, PRICE IN CASES
				WHEN '2'   THEN 1/(OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODPALLET)		-- VOL IN CONS PKG , PRICE IN PALLETS
				ELSE 	 1												-- VOL IN CONS PKG, PRICE IN CONS PKGS
				END)*spp.TDELENTR.DELEPRICE*OLAP_LPROPROD.PRODMONEY_MULT * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT
	END AS DELEMONETARY , 

	-- price is per CONS PKG in product table
	CASE DELEVOLFLG
		WHEN '1' THEN OLAP_LPROPROD.PRODSIZE* OLAP_LPROPROD.PRODPRICE * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT*(OLAP_LPROPROD.PRODMONEY_MULT) 			-- VOL IN CASES, PRICE IN CONS PKG
		ELSE OLAP_LPROPROD.PRODPRICE * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT*(OLAP_LPROPROD.PRODMONEY_MULT)	-- VOL IN CONS PKG, PRICE IN CONS PKG
	END AS DELEMONETARY_PRODPRICE , 


	ISNULL((SELECT TOP 1 SELE_PURCH_PRICE_NET FROM spp.OLAP_TSELENTR t1 WHERE t1.PRODSERN=spp.TDELENTR.PRODSERN and  t1.SELESTART<=spp.TDELIVER.DELDATE and  t1.SELEEND>=spp.TDELIVER.DELDATE and EXISTS(SELECT TOP 1 1 FROM spp.OLAP_LCOMSEL t2 WHERE t1.SELSERN=t2.SELSERN AND t2.COMSERNO=spp.TDELIVER.COMSERNO) ),0)*
		(CASE DELEVOLFLG
		WHEN '1' THEN  OLAP_LPROPROD.PRODSIZE * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT 	-- VOL IN CASES, PRICE IN CONS PKGS
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT							-- VOL IN CONS PKG, PRICE IN CONS PKGS
		END)*OLAP_LPROPROD.PRODMONEY_MULT
	AS DELEMONETARY_PRICELIST , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL* OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODCASE_MULT
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT
	END AS DELEACTVOL , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODCPS*OLAP_LPROPROD.PRODCASE_MULT
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPS*OLAP_LPROPROD.PRODCPG_MULT
	END AS DELEACTUNITS , 


	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODCPWNET*OLAP_LPROPROD.PRODCASE_MULT/1000 --kilograms
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPWNET*OLAP_LPROPROD.PRODCPG_MULT/1000 --kilograms
	END AS DELENETWT , 


	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODCPWGR*OLAP_LPROPROD.PRODCASE_MULT/1000 --kilograms
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPWGR*OLAP_LPROPROD.PRODCPG_MULT/1000 --kilograms
	END AS DELECPWGR , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASEWGR*OLAP_LPROPROD.PRODCASE_MULT/1000 --kilograms
		ELSE (spp.TDELENTR.DELEACTVOL/OLAP_LPROPROD.PRODSIZE)*OLAP_LPROPROD.PRODCASEWGR*OLAP_LPROPROD.PRODCPG_MULT/1000 --kilograms
	END AS DELECASEWGR , 
	
	
	-- cases are calculated from child product sum cases
	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT*OLAP_LPROPROD.CHILDCASE_MULT
		ELSE (spp.TDELENTR.DELEACTVOL/OLAP_LPROPROD.PRODSIZE)*OLAP_LPROPROD.PRODCPG_MULT*OLAP_LPROPROD.CHILDCASE_MULT
	END AS DELEACTCASEVOL , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT/OLAP_LPROPROD.PRODPALLET
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT/(OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODPALLET)
	END AS DELEACTPALLETVOL ,

	CASE DELEPRFLAG
		WHEN '1'   THEN (spp.TDELENTR.DELEPRICE/ OLAP_LPROPROD.PRODSIZE)*OLAP_LPROPROD.PRODMONEY_MULT		-- PRICE IN CASES
		WHEN '2'   THEN (spp.TDELENTR.DELEPRICE /(OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODPALLET))*OLAP_LPROPROD.PRODMONEY_MULT		-- PRICE IN PALLETS
		ELSE 	spp.TDELENTR.DELEPRICE*OLAP_LPROPROD.PRODMONEY_MULT												-- PRICE IN CONS PKGS
	END AS DELEPRICE_NET,

	CASE DELEPRFLAG
		WHEN '1'   THEN spp.TDELENTR.DELEPRICE / OLAP_LPROPROD.PRODSIZE * ( 1 + OLAP_LPROPROD.PRODTAX/100)*OLAP_LPROPROD.PRODMONEY_MULT		-- PRICE IN CASES
		WHEN '2'   THEN spp.TDELENTR.DELEPRICE / (OLAP_LPROPROD.PRODSIZE * OLAP_LPROPROD.PRODPALLET )* ( 1 +OLAP_LPROPROD.PRODTAX/100)*OLAP_LPROPROD.PRODMONEY_MULT			-- PRICE IN PALLETS
		ELSE 	spp.TDELENTR.DELEPRICE* ( 1 + OLAP_LPROPROD.PRODTAX/100)*OLAP_LPROPROD.PRODMONEY_MULT			-- PRICE IN CONS PKGS
	END AS DELEPRICE_GROSS

FROM  spp.TDELIVER INNER JOIN
               spp.TDELENTR ON spp.TDELIVER.DELSERN = spp.TDELENTR.DELSERN
INNER JOIN spp.OLAP_STORE ON ISNULL(spp.TDELIVER.COMSERNO,'0')=spp.OLAP_STORE.COMSERNO
INNER JOIN spp.OLAP_LPROPROD OLAP_LPROPROD ON ISNULL(spp.TDELENTR.PRODSERN,'0')=OLAP_LPROPROD.PARENT_PRODSERN
WHERE spp.TDELIVER.COMSERNWHS='0' OR LEN(LTRIM(spp.TDELIVER.COMSERNWHS))=15  -- IN POS = 0

GO












CREATE VIEW spp.V_OLAP_DELIVER_POS
AS

SELECT  
spp.OLAP_STORE.COMSERNO,
ISNULL(spp.TDELIVER.COMSERNCCH , '') AS COMSERNCCH, 
ISNULL(spp.TDELIVER.COMSERNCHN , '') AS COMSERNCHN, 
ISNULL(spp.TDELIVER.COMSERNWHS , '') AS COMSERNWHS, 
OLAP_LPROPROD.PRODSERN, 

ISNULL((SELECT 
CASE
	WHEN COUNT(*)>1 THEN '-1'
	ELSE MAX(SALMSERN)
END AS SALMSERN 
FROM spp.OLAP_LCOMPGR OLAP_LCOMPGR  LEFT OUTER JOIN spp.OLAP_LPROPGR OLAP_LPROPGR ON OLAP_LCOMPGR.PGRSERN=OLAP_LPROPGR.PGRSERN 
WHERE OLAP_LCOMPGR.COMSERNO=spp.OLAP_STORE.COMSERNO AND OLAP_LPROPGR.PRODSERN=OLAP_LPROPROD.PRODSERN
),'0')
 AS STORE_SALMSERN ,

OLAP_LPROPROD.PRODEXPAND ,
ISNULL(spp.TDELENTR.SALMSERN , '') AS SALMSERN , 
spp.TDELIVER.DELDATE,

	CASE DELEVOLFLG
		WHEN '1' THEN (CASE DELEPRFLAG
					WHEN '1'   THEN  1 								-- VOL IN CASES, PRICE IN CASES
					WHEN '2'   THEN (1/OLAP_LPROPROD.PRODPALLET)			-- VOL IN CASES , PRICE IN PALLETS
					ELSE 	(OLAP_LPROPROD.PRODSIZE) 					-- VOL IN CASES, PRICE IN CONS PKGS
					END)*spp.TDELENTR.DELEPRICE*OLAP_LPROPROD.PRODMONEY_MULT* spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT
		ELSE (CASE DELEPRFLAG
				WHEN '1'   THEN (1/OLAP_LPROPROD.PRODSIZE) 							-- VOL IN CONS PKG, PRICE IN CASES
				WHEN '2'   THEN 1/(OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODPALLET)		-- VOL IN CONS PKG , PRICE IN PALLETS
				ELSE 	 1												-- VOL IN CONS PKG, PRICE IN CONS PKGS
				END)*spp.TDELENTR.DELEPRICE*OLAP_LPROPROD.PRODMONEY_MULT * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT
	END AS DELEMONETARY_NET , 

	CASE DELEVOLFLG
		WHEN '1' THEN (CASE DELEPRFLAG
					WHEN '1'   THEN  1 								-- VOL IN CASES, PRICE IN CASES
					WHEN '2'   THEN (1/OLAP_LPROPROD.PRODPALLET)			-- VOL IN CASES , PRICE IN PALLETS
					ELSE 	(OLAP_LPROPROD.PRODSIZE) 					-- VOL IN CASES, PRICE IN CONS PKGS
					END)*spp.TDELENTR.DELEPRICE*OLAP_LPROPROD.PRODMONEY_MULT* spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT*( 1 + OLAP_LPROPROD.PRODTAX/100)
		ELSE (CASE DELEPRFLAG
				WHEN '1'   THEN (1/OLAP_LPROPROD.PRODSIZE) 							-- VOL IN CONS PKG, PRICE IN CASES
				WHEN '2'   THEN 1/(OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODPALLET)		-- VOL IN CONS PKG , PRICE IN PALLETS
				ELSE 	 1												-- VOL IN CONS PKG, PRICE IN CONS PKGS
				END)*spp.TDELENTR.DELEPRICE*OLAP_LPROPROD.PRODMONEY_MULT * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT*( 1 + OLAP_LPROPROD.PRODTAX/100)
	END AS DELEMONETARY_GROSS , 


	-- price is per CONS PKG in product table
	CASE DELEVOLFLG
		WHEN '1' THEN OLAP_LPROPROD.PRODSIZE* OLAP_LPROPROD.PRODPRICE * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT*(OLAP_LPROPROD.PRODMONEY_MULT) 			-- VOL IN CASES, PRICE IN CONS PKG
		ELSE OLAP_LPROPROD.PRODPRICE * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT*(OLAP_LPROPROD.PRODMONEY_MULT)	-- VOL IN CONS PKG, PRICE IN CONS PKG
	END AS DELEMONETARY_PRODPRICE , 


	ISNULL((SELECT TOP 1 SELE_PURCH_PRICE_NET FROM spp.OLAP_TSELENTR t1 WHERE t1.PRODSERN=spp.TDELENTR.PRODSERN and  t1.SELESTART<=spp.TDELIVER.DELDATE and  t1.SELEEND>=spp.TDELIVER.DELDATE and EXISTS(SELECT TOP 1 1 FROM spp.OLAP_LCOMSEL t2 WHERE t1.SELSERN=t2.SELSERN AND t2.COMSERNO=spp.TDELIVER.COMSERNO) ),0)*
		(CASE DELEVOLFLG
		WHEN '1' THEN  OLAP_LPROPROD.PRODSIZE * spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT 	-- VOL IN CASES, PRICE IN CONS PKGS
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT							-- VOL IN CONS PKG, PRICE IN CONS PKGS
		END)*OLAP_LPROPROD.PRODMONEY_MULT
	AS DELEMONETARY_PRICELIST , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL* OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODCASE_MULT
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT
	END AS DELEACTVOL , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODCPS*OLAP_LPROPROD.PRODCASE_MULT
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPS*OLAP_LPROPROD.PRODCPG_MULT
	END AS DELEACTUNITS , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODCPWNET*OLAP_LPROPROD.PRODCASE_MULT/1000 --kilograms
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPWNET*OLAP_LPROPROD.PRODCPG_MULT/1000 --kilograms
	END AS DELENETWT , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODCPWGR*OLAP_LPROPROD.PRODCASE_MULT/1000 --kilograms
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPWGR*OLAP_LPROPROD.PRODCPG_MULT/1000 --kilograms
	END AS DELECPWGR , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASEWGR*OLAP_LPROPROD.PRODCASE_MULT/1000 --kilograms
		ELSE (spp.TDELENTR.DELEACTVOL/OLAP_LPROPROD.PRODSIZE)*OLAP_LPROPROD.PRODCASEWGR*OLAP_LPROPROD.PRODCPG_MULT/1000 --kilograms
	END AS DELECASEWGR , 
	
	-- cases are calculated from child product sum cases
	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT*OLAP_LPROPROD.CHILDCASE_MULT
		ELSE (spp.TDELENTR.DELEACTVOL/OLAP_LPROPROD.PRODSIZE)*OLAP_LPROPROD.PRODCPG_MULT*OLAP_LPROPROD.CHILDCASE_MULT
	END AS DELEACTCASEVOL , 

	CASE DELEVOLFLG
		WHEN '1'  THEN  spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCASE_MULT/OLAP_LPROPROD.PRODPALLET
		ELSE spp.TDELENTR.DELEACTVOL*OLAP_LPROPROD.PRODCPG_MULT/(OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODPALLET)
	END AS DELEACTPALLETVOL ,

	CASE DELEPRFLAG
		WHEN '1'   THEN (spp.TDELENTR.DELEPRICE/ OLAP_LPROPROD.PRODSIZE)*OLAP_LPROPROD.PRODMONEY_MULT		-- PRICE IN CASES
		WHEN '2'   THEN (spp.TDELENTR.DELEPRICE /(OLAP_LPROPROD.PRODSIZE*OLAP_LPROPROD.PRODPALLET))*OLAP_LPROPROD.PRODMONEY_MULT		-- PRICE IN PALLETS
		ELSE 	spp.TDELENTR.DELEPRICE*OLAP_LPROPROD.PRODMONEY_MULT												-- PRICE IN CONS PKGS
	END AS DELEPRICE_NET,

	CASE DELEPRFLAG
		WHEN '1'   THEN spp.TDELENTR.DELEPRICE / OLAP_LPROPROD.PRODSIZE * ( 1 + OLAP_LPROPROD.PRODTAX/100)*OLAP_LPROPROD.PRODMONEY_MULT		-- PRICE IN CASES
		WHEN '2'   THEN spp.TDELENTR.DELEPRICE / (OLAP_LPROPROD.PRODSIZE * OLAP_LPROPROD.PRODPALLET )* ( 1 +OLAP_LPROPROD.PRODTAX/100)*OLAP_LPROPROD.PRODMONEY_MULT			-- PRICE IN PALLETS
		ELSE 	spp.TDELENTR.DELEPRICE* ( 1 + OLAP_LPROPROD.PRODTAX/100)*OLAP_LPROPROD.PRODMONEY_MULT			-- PRICE IN CONS PKGS
	END AS DELEPRICE_GROSS

FROM  spp.TDELIVER INNER JOIN
               spp.TDELENTR ON spp.TDELIVER.DELSERN = spp.TDELENTR.DELSERN
INNER JOIN spp.OLAP_STORE ON  ISNULL(spp.TDELIVER.COMSERNO,'0')=spp.OLAP_STORE.COMSERNO
INNER JOIN spp.OLAP_LPROPROD OLAP_LPROPROD ON ISNULL(spp.TDELENTR.PRODSERN,'0')=OLAP_LPROPROD.PARENT_PRODSERN
WHERE LEN(LTRIM(ISNULL(spp.TDELIVER.COMSERNWHS,'')))=0

GO

















